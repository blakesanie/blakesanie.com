<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <title>Creating Photo Mosaics from Spotify Album Covers</title>
        <meta name="description" content="Recreating images out of album covers in a user's Spotify playlists."/>
        <link rel="apple-touch-icon" sizes="57x57" href="/favicons/apple-icon-57x57.png">
        <link rel="apple-touch-icon" sizes="60x60" href="/favicons/apple-icon-60x60.png">
        <link rel="apple-touch-icon" sizes="72x72" href="/favicons/apple-icon-72x72.png">
        <link rel="apple-touch-icon" sizes="76x76" href="/favicons/apple-icon-76x76.png">
        <link rel="apple-touch-icon" sizes="114x114" href="/favicons/apple-icon-114x114.png">
        <link rel="apple-touch-icon" sizes="120x120" href="/favicons/apple-icon-120x120.png">
        <link rel="apple-touch-icon" sizes="144x144" href="/favicons/apple-icon-144x144.png">
        <link rel="apple-touch-icon" sizes="152x152" href="/favicons/apple-icon-152x152.png">
        <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-icon-180x180.png">
        <link rel="icon" type="image/png" sizes="192x192" href="/favicons/android-icon-192x192.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="96x96" href="/favicons/favicon-96x96.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
        <link rel="manifest" href="/favicons/manifest.json">
        <meta name="msapplication-TileColor" content="#ffffff">
        <meta name="msapplication-TileImage" content="/favicons/ms-icon-144x144.png">
        <meta name="theme-color" content="#ffffff">
        <meta property="og:image" content="/siteThumb.png">
        <meta property="og:image:type" content="image/png">
        <meta property="og:image:width" content="1200">
        <meta property="og:image:height" content="1200">
        <link rel="stylesheet" href="../base.css" type="text/css">
        <link rel="stylesheet" href="postStyle.css" type="text/css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/gist-embed/2.7.1/gist-embed.min.js"></script>
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-164774604-1"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag() {
                dataLayer.push(arguments);
            }
            gtag('js', new Date());

            gtag('config', 'UA-164774604-1');
        </script>

    </head>
    <body>
        <div id="header">
            <h1>Blake Sanie</h1>
            <h2>Inquisitive student. Aspiring engineer. Photography enthusiast. Curious stock trader.</h2>
            <div id="menuIcon">
                <div class="line"></div>
                <div class="line"></div>
                <div class="line"></div>
            </div>
            <div id="nav">
                <a href="/">
                    <h3>Home</h3>
                </a>
                <h3 class="category">Engineering</h3>
                <a href="/resume">
                    <h3>R√©sum√©</h3>
                </a>
                <a href="/cs">
                    <h3>Projects</h3>
                </a>
                <a href="/fund" target="_blank">
                    <h3>Stock Fund</h3>
                </a>
                <a href="http://www.investivision.com" target="_blank">
                    <h3>Investivision
                        <sup>‚Üó</sup>
                    </h3>
                </a>
                <a href="/blog">
                    <h3>Blog</h3>
                </a>
                <a href="https://github.com/blakesanie" target="_blank">
                    <h3>GitHub
                        <sup>‚Üó</sup>
                    </h3>
                </a>
                <h3 class="category">Photography</h3>
                <a href="/photo">
                    <h3>Portfolio</h3>
                </a>
                <a href="/photo/gear">
                    <h3>Gear</h3>
                </a>
                <h3 class="category">Personal
                </h3>
                <a href="mailto:blake@sanie.com">
                    <h3>Email
                        <sup>‚Üó</sup>
                    </h3>
                </a>
                <a href="https://www.linkedin.com/in/blake-sanie-77733116a/" target="_blank">
                    <h3>LinkedIn
                        <sup>‚Üó</sup>
                    </h3>
                </a>
                <a href="https://www.instagram.com/blake_sanie/" target="_blank">
                    <h3>Instagram
                        <sup>‚Üó</sup>
                    </h3>
                </a>
            </div>
            <h4>made by Blake Sanie with ‚ô•</h4>
        </div>
        <div id="content">
            <h1>Generating Photo Mosaics out of Album Covers (from Spotify!)</h1>
            <p id="date">Feb 17, 2019</p>
            <a href="/spotifyMosaic" target="_blank">
                <h2>
                    Visit the web app here!<br/>
                </h2>
            </a>
            <p>One day, I had the thought of creating a giant poster of iconic album covers. I already began to figure out how to stitch images together onto a single canvas with JavaScript. However, I realized I would be the only one to use my software. Wanting
                others to use this artistic tool for themselves, I converted my algorithms into a web app. For an extra touch of personalization, the album cover pool used to compose mosaics come directly from the user's spotify playlists! Here's an example of my
                own music used to represent the Golden Gate Bridge:</p>
            <img src="./images/sampleMosaic.png"/>
            <p>Wow üòç. I needed to keep working on this project.</p>
            <h2>Prerequisites</h2>
            <ol>
                <li>Javascript/<a href="https://en.wikipedia.org/wiki/JQuery" target="_blank">jQuery</a>
                </li>
                <li>
                    <a href="https://en.wikipedia.org/wiki/Canvas_element" target="_blank">HTML5 Canvas</a>
                </li>
                <li>API Requests</li>
                <li>Iteration/Selection</li>
                <li>Good Music Taste</li>
            </ol>
            <h2>Plan</h2>
            <ol>
                <li>Authenticate user with
                    <a href="https://www.spotify.com" target="_blank">Spotify</a>
                </li>
                <li>Obtain album covers from playlists</li>
                <li>Select image to be recreated</li>
                <li>Generate photo mosaic</li>
                <li>Allow creation to be downloaded</li>
            </ol>
            <p>This walkthrough will focus less on the UI, and more on the app's underlying functions.</p>
            <h2>Launching the Website</h2>
            <p>All operations will be made from localhost. Our website's source files will be served through this simple http server made with Node.js and Express. Upon typing "$ node simpleServer.js" into the command line, we can find index.html at
                http://localhost:8888/.</p>
            <code data-gist-id="3df6c3fc148dd3cf0e520cb90fd7346d"></code>
            <h2>Spotify Authentication Flow</h2>
            <p>First, let's set up an app on Spotify's
                <a href="https://www.developer.spotify.com" target="_blank">developer site</a>. There, we can obtain our client key: a string that allows us access to the services API. We can also set a whitelist of redirect urls for when the user has successfully
                signed in. I whitelisted multiple urls for production (domain) and development (localhost:port#).</p>
            <h4>Signing into Spotify</h4>
            <p>Clicking on an element $("#login") will redirect the user to Spotify's authentication page. Inserted into the url are parameters containing our desired redirect url (same page), client key, and state string. Spotify's servers use this state string
                to ensure security across API calls. The front end sends a unique string to Spotify's back end. If the response does not contains the same state value, we know that the response is not intended for us or was tampered with.</p>
            <code data-gist-id="3b0de58f83577c0188f1cea8b33e2dbe" data-gist-line="32-44"></code>
            <p>When the user returns from the spotify login page, the location url has hash params containing an access token and the state key. Let's save these values for the next step.</p>
            <code data-gist-id="3b0de58f83577c0188f1cea8b33e2dbe" data-gist-line="3-12,25-30"></code>
            <h4>Loading User Information</h4>
            <p>Now, we can compare the returned state to the value we sent. If the values are identical, we can use our access token to query Spotify's API for the user's profile information. We'll save all user data under a global variable for use everywhere
                throughout the project.</p>
            <code data-gist-id="3b0de58f83577c0188f1cea8b33e2dbe" data-gist-line="24,45-49,52-56,61-64"></code>
            <h4>Processing Playlist and Track Data</h4>
            <p>We can also query Spotify for the user's playlists. At the same time, let's traverse each playlist's tracks and create an array of unique album covers. Again, information is saved to the global data value.</p>
            <code data-gist-id="3b0de58f83577c0188f1cea8b33e2dbe" data-gist-line="65-73,77-88,90-91,138-145,149-172"></code>
            <h2>Generating the Mosaic</h2>
            <p>In the UI, the user has selected which playlists it wants to include in the mosaic. We can iterate across these playlists and compile an array of unique album covers. Also, let's calculate each photo's average color
                <span class="italics">now</span>
                to save time later.</p>
            <code data-gist-id="0b73834ac9c9ea091ca1688f60b9ba8c" data-gist-line="7-8,54,98-121"></code>
            <p>Then, we compute the mosaic's tile dimensions. Our algorithm maximizes the number of tiles without going over the user-set maximum value.</p>
            <code data-gist-id="0b73834ac9c9ea091ca1688f60b9ba8c" data-gist-line="6,9-24"></code>
            <p>Using a canvas element, let's resize the target image to the tile dimensions we just calculated.</p>
            <code data-gist-id="0b73834ac9c9ea091ca1688f60b9ba8c" data-gist-line="28-36,53"></code>
            <p>At the same time, let's set up our mosaic canvas, which we will draw album covers onto and display to the user. Each album cover's width is 64 pixels.</p>
            <code data-gist-id="0b73834ac9c9ea091ca1688f60b9ba8c" data-gist-line="3-4,25-27"></code>
            <h4>Finding the Right Album Covers</h4>
            <p>This is where the code gets interesting. Canvas has a method that allows us to extract pixel data as a one-dimensional array. Every four values follow the repeating pattern {r, g, b, a}. For our pursposes, let's create a new array of pixel
                objects. We can ignore the alpha chanel.</p>
            <code data-gist-id="0b73834ac9c9ea091ca1688f60b9ba8c" data-gist-line="37-46"></code>
            <p>At this point, the computer's fans might start to spin. For each pixel, we try to find the album cover with the closest average color, according to a least-mean-square formula.
            </p>
            <code data-gist-id="0b73834ac9c9ea091ca1688f60b9ba8c" data-gist-line="48-50,52"></code>
            <h4>Presenting Mosaic to User</h4>
            <p>Drawing album covers onto our mosaic canvas uses the same drawing method from earlier. Once we calculate the image's x and y offset, we can essentially paste the album cover onto the canvas, one at a time. When all images are rendered, we prepare
                the canvas for an image download.</p>
            <code data-gist-id="0b73834ac9c9ea091ca1688f60b9ba8c" data-gist-line="51,76-91"></code>
            <p>The canvas' data is extracted as a PNG and formatted as a dataURL. We can attatch this url to the UI's download button, which will take the user to a new tab with just the image (downloadable).</p>
            <code data-gist-id="0b73834ac9c9ea091ca1688f60b9ba8c" data-gist-line="93-97"></code>
            <h2>Create Your Album Cover Masterpiece</h2>
            <a href="http://www.blakesanie.com/spotifyMosaic">
                <h4>Visit the site here</h4>
            </a>
            <p>
                I'd LOVE to see what you come up with. Share your mosaics with
                <a href="https://www.instagram.com/blake_sanie/" target="_blank">me on Instagram</a>.</p>
            <div id="disqus_thread"></div>
        </div>
        <script>
            var disqus_config = function () {
                this.page.url = "http://www.blakesanie.com/blog/mosaic.html";
                this.page.identifier = "mosaic";
            };
            (function () { // DON'T EDIT BELOW THIS LINE
                var d = document,
                    s = d.createElement('script');
                s.src = 'https://blakesanie-com.disqus.com/embed.js';
                s.setAttribute('data-timestamp', + new Date());
                (d.head || d.body).appendChild(s);
            })();
        </script>
        <noscript>Please enable JavaScript to view the
            <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
        <script src="../main.js"></script>
        <script src="functions.js"></script>
    </body>
</html>