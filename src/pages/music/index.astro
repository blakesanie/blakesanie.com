---
import HeaderAndFooter from "../../components/HeaderAndFooter/index.astro";
---

<HeaderAndFooter allowMainStyles title="Music Converter">
  <h1></h1>
</HeaderAndFooter>

<script>
  function getHashParams() {
    var hashParams = {};
    var e,
      r = /([^&;=]+)=?([^&;]*)/g,
      q = window.location.hash.substring(1);
    while ((e = r.exec(q))) {
      hashParams[e[1]] = decodeURIComponent(e[2]);
    }
    return hashParams;
  }

  function toTitleCase(str) {
    return str.replace(/\w\S*/g, function (txt) {
      return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
    });
  }

  const h1 = document.querySelector("h1");

  function setMessage(message) {
    if (h1) {
      h1.textContent = message;
    }
  }

  function copyToClipboard(text) {
    if (navigator.userAgent.match(/ipad|ipod|iphone/i)) {
      // handle iOS devices

      var input = document.createElement("input");
      input.type = "text";
      input.value = text;

      input.contenteditable = true;
      input.readonly = false;

      var range = document.createRange();
      range.selectNodeContents(input);

      var selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(range);
      input.setSelectionRange(0, 999999);
      document.execCommand("copy");

      input.remove();
    } else {
      // other devices are easy
      navigator.clipboard.writeText(text);
    }
  }

  let song;
  let artist;

  const params = getHashParams();

  async function processClipboard(paste) {
    localStorage.setItem("paste", paste);
    let spotifyToken = params.access_token;
    if (spotifyToken) {
      localStorage.setItem("spotifyToken", spotifyToken);
      localStorage.setItem(
        "spotifyTokenExp",
        `${new Date().getTime() + parseInt(params.expires_in) * 1000}`
      );
    }
    // debugger;
    if (paste.includes("spotify.com")) {
      // https://open.spotify.com/track/2w4OTUEZdpNoTFK64fEEIg?si=f7pyOBhuRUCWBAzPmbRYRQ
      const storedExp = localStorage.getItem("spotifyTokenExp");
      //   debugger;
      spotifyToken =
        spotifyToken ||
        (storedExp &&
          new Date(parseInt(storedExp)) > new Date() &&
          localStorage.getItem("spotifyToken"));
      if (!spotifyToken) {
        const client_id = "ea58eca152454aed8601582fd602ce90"; // Your client id
        const redirect_uri = window.location.href; // Your redirect uri

        const state = "blake";

        // var scope = 'user-read-private user-read-email';

        var url = "https://accounts.spotify.com/authorize";
        url += "?response_type=token";
        url += "&client_id=" + encodeURIComponent(client_id);
        // url += '&scope=' + encodeURIComponent(scope);
        url += "&redirect_uri=" + encodeURIComponent(redirect_uri);
        // url += '&state=' + encodeURIComponent(state);
        alert(redirect_uri);
        window.location = url;
      }
      //   debugger;
      const trackId = paste.split("/").slice(-1)[0].split("?")[0];
      console.log("spotify token", spotifyToken);

      setMessage("Processing");
      const res = await fetch("https://api.spotify.com/v1/tracks/" + trackId, {
        method: "GET",
        headers: {
          Authorization: `Bearer ${spotifyToken}`,
        },
      });
      const json = await res.json();
      song = json.name;
      artist = json.artists
        .map((artist) => {
          return artist.name;
        })
        .join(", ");
      const desc = song + " by " + artist;
      copyToClipboard(
        `https://music.apple.com/us/search?term=${encodeURIComponent(
          desc
        )}\n${desc}`
      );
      setMessage("Converted to Apple Music");
    } else if (paste.includes("apple.com")) {
      const title = paste
        .split("/album/")[1]
        .split("/")[0]
        .replaceAll("-", " ");
      song = toTitleCase(title);
      copyToClipboard(
        `https://open.spotify.com/search/${encodeURIComponent(song)}\n${song}`
      );
      setMessage("Converted to Spotify");
    } else {
      setMessage("Paste Link Here");
    }
  }

  async function main() {
    let paste;
    // debugger;
    try {
      paste = await navigator.clipboard.readText();
    } catch (e) {}
    paste = paste || (params.access_token && localStorage.getItem("paste"));
    if (paste) {
      processClipboard(paste);
    } else {
      setMessage("Paste Link Here");
    }
  }
  //   debugger;
  main();

  if (h1) {
    h1.addEventListener("click", async () => {
      main();
    });
  }

  // https://open.spotify.com/track/2w4OTUEZdpNoTFK64fEEIg?si=f7pyOBhuRUCWBAzPmbRYRQ
  // https://music.apple.com/us/album/shot-in-the-dark/1568819304?i=1568819313
  // https://music.apple.com/us/album/wild-blue/1568819304?i=1568819312
  // https://music.apple.com/us/album/such-a-simple-thing/1616740351?i=1616740705
  // https://music.apple.com/us/album/get-on/1355757318?i=1355757324
</script>
